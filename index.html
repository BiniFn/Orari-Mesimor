<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BiniFn ‚Äî 365 Day Livestream Challenge</title>
<style>
:root {
  --accent: #ff0000;
  --accent-dark: #8b0000;
  --glow: rgba(255,0,0,0.9);
  --bg-tint: rgba(0,0,0,0.45);
  --text: #ffffff;
  --max-width: 1200px;
  --ui-padding: 20px;
  --card-radius: 16px;
  --muted: rgba(255,255,255,0.12);
  --transition-fast: 180ms;
  --transition-smooth: 360ms;
}

* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { width: 100%; }
html { height: auto; }
body {
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: radial-gradient(ellipse at top, #0b0000 0%, #000 66%);
  color: var(--text);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  /* let the body size naturally so mobile browsers can adjust viewport height
    and avoid clipping when the browser chrome (address bar/keyboard) toggles */
  min-height: auto;
  display: flex;
  /* allow the page to scroll vertically but never horizontally; align content to the top so
    nothing gets clipped on mobile when browser chrome or keyboard changes viewport height */
  align-items: flex-start;
  justify-content: center;
  overflow-x: hidden;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  /* add a little horizontal padding for mobile safe area and reserve safe-area inset on top */
  padding: calc(20px + env(safe-area-inset-top, 0px)) 12px 20px;
}

.app {
  width: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  position: relative;
  z-index: 0;
  /* allow the app container to grow naturally and not force a fixed viewport height
     which caused content to be clipped on some devices */
  min-height: 0;
  max-width: 100%;
}

/* Prevent any element from causing horizontal scroll on small screens */
img, svg, canvas {
  max-width: 100%;
  height: auto;
  display: block;
}

/* ensure containers never exceed viewport width due to box-shadow or borders */
.container, .card, .codex-card {
  max-width: 100%;
}

.background {
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
  background: radial-gradient(ellipse at top, rgba(10,0,0,0.95) 0%, #000 70%);
}

.bg-overlay {
  position: fixed;
  inset: 0;
  z-index: 0;
  pointer-events: none;
  background: linear-gradient(180deg, rgba(0,0,0,0.0), var(--bg-tint));
  mix-blend-mode: screen;
}

.particles { position: fixed; inset: 0; z-index: 1; pointer-events: none; }
.particle {
  position: absolute;
  width: 3px;
  height: 3px;
  border-radius: 50%;
  background: var(--accent);
  box-shadow: 0 0 8px var(--accent);
  opacity: 0;
  animation: float 12s linear infinite;
  will-change: transform, opacity;
}

@keyframes float {
  0% { transform: translateY(0) translateX(0); opacity: 0; }
  8% { opacity: 0.8; }
  92% { opacity: 0.6; }
  100% { transform: translateY(-110vh) translateX(80px); opacity: 0; }
}

.container {
  z-index: 2;
  width: 100%;
  max-width: 95%;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 28px;
  padding: 15px;
  box-sizing: border-box;
  flex-direction: column;
  margin: 0 auto;
}

/* Audio toggle styles */
#audioToggle {
  /* button is positioned by its container (#audioControls) to avoid overlap */
  width: 44px;
  height: 44px;
  border-radius: 999px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(0,0,0,0.12));
  color: #fff;
  border: 1px solid rgba(255,255,255,0.06);
  box-shadow: 0 6px 20px rgba(0,0,0,0.45);
  font-size: 18px;
  cursor: pointer;
}
#audioToggle[aria-pressed="true"]{ background: linear-gradient(135deg, var(--accent-dark), var(--accent)); box-shadow: 0 8px 28px rgba(0,0,0,0.55); }

@media (max-width:480px){
  #audioToggle{ right: 8px; top: calc(8px + env(safe-area-inset-top, 0px)); width:40px; height:40px; }
}

#audioControls { position: fixed; right: 12px; top: 12px; display: flex; gap:10px; align-items:center; z-index:14000; /* place slider to the left of the button so it expands left */ flex-direction: row-reverse; }
#audioControls input[type="range"]{ width:120px; -webkit-appearance:none; appearance:none; height:6px; background: rgba(255,255,255,0.08); border-radius:999px; accent-color: var(--accent); }
#audioControls input[type="range"]::-webkit-slider-runnable-track{ height:6px; background: rgba(255,255,255,0.08); border-radius:999px; }
#audioControls input[type="range"]::-webkit-slider-thumb{ -webkit-appearance:none; width:12px; height:12px; border-radius:50%; background:var(--accent); box-shadow:0 4px 10px rgba(0,0,0,0.4); margin-top: -3px; }
#audioControls input[type="range"]::-moz-range-track{ height:6px; background: rgba(255,255,255,0.08); border-radius:999px; }
#audioControls input[type="range"]::-moz-range-thumb{ width:12px; height:12px; border-radius:50%; background:var(--accent); }

@media (max-width:480px){
  #audioControls input[type="range"]{ width:88px; }
}

/* volume hidden by default; revealed when user presses the toggle
  keep the input in the flow but collapsed so transitions are smooth */
#audioControls input[type="range"]{ display:block; opacity:0; width:0; transition: width .18s ease, opacity .18s ease, margin .18s ease; pointer-events: none; }
#audioControls.show-volume input[type="range"]{ opacity:1; width:120px; margin-right:8px; pointer-events: auto; }
@media (max-width:480px){ #audioControls.show-volume input[type="range"]{ width:88px; } }

/* debug & file picker UI near audio controls - themed to match site variables */
#audioDebug{
  position: fixed; right: 12px; top: 68px; z-index:14001;
  color: black; font-size: 1px; max-width:240px; text-align:right;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.26));
  padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,0.04);
  box-shadow: 0 6px 20px rgba(0,0,0,0.45);
}
#audioChooseBtn{
  position: fixed; right: 12px; top: 112px; z-index:14002; display:none;
  padding:8px 10px; border-radius:10px; background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(0,0,0,0.12));
  color: var(--text); border:1px solid var(--accent); cursor:pointer; font-weight:700;
}

@media (max-width: 600px) {
  :root {
    --ui-padding: 10px;
  }
  /* Keep audio controls in their desktop position (top-right) but allow other mobile layout changes below */
  /* debug / choose button keep their default positions so they don't overlap the content */
}

.header {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  width: 100%;
}

.logo {
  font-weight: 900;
  font-size: clamp(1.8rem, 6vw, 3.5rem);
  letter-spacing: 0.06em;
  color: var(--text);
  text-shadow: 0 0 8px var(--accent), 0 0 18px var(--accent), 0 0 26px var(--accent-dark);
  cursor: default;
  user-select: none;
  white-space: nowrap;
  overflow: visible;
}

.subtitle {
  color: #ff6666;
  text-transform: uppercase;
  font-weight: 300;
  letter-spacing: 0.22em;
  font-size: clamp(0.8rem, 2vw, 1rem);
}

.card {
  width: min(720px, 96%);
  max-width: 720px;
  border-radius: var(--card-radius);
  padding: 24px;
  background: linear-gradient(135deg, rgba(139,0,0,0.18), rgba(0,0,0,0.55));
  border: 2px solid var(--accent);
  box-shadow: 0 8px 34px rgba(0,0,0,0.6);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

.day-label { 
  color: var(--accent); 
  text-transform: uppercase; 
  letter-spacing: 0.14em; 
  font-weight: 700; 
}

.day-display {
  font-size: clamp(2.6rem, 9vw, 4.6rem);
  font-weight: 900;
  color: var(--text);
  text-shadow: 0 0 18px var(--accent), 0 0 36px var(--accent);
  transition: transform var(--transition-fast) ease, text-shadow var(--transition-fast) ease;
}

.progress-container { width: 100%; margin-top: 6px; }
.progress-label { 
  display: flex; 
  justify-content: space-between; 
  width: 100%; 
  color: var(--accent); 
  font-weight: 700; 
  font-size: 0.95rem; 
}

.progress-bar { 
  margin-top: 8px; 
  height: 12px; 
  width: 100%; 
  background: rgba(255,0,0,0.08); 
  border-radius: 999px; 
  overflow: hidden; 
  border: 1px solid rgba(255,0,0,0.08); 
}

.progress-fill { 
  height: 100%; 
  width: 0; 
  background: linear-gradient(90deg, var(--accent-dark), var(--accent)); 
  box-shadow: 0 0 12px var(--glow); 
  transition: width 0.9s cubic-bezier(0.1,0.9,0.2,1); 
  border-radius: 999px; 
}

.controls { width: 100%; display: flex; align-items: center; justify-content: center; margin-top: 16px; gap: 12px; }
.next-button {
  padding: 14px 44px;
  border-radius: 999px;
  background: linear-gradient(135deg, var(--accent-dark), var(--accent));
  border: 2px solid var(--accent);
  color: #fff;
  font-weight: 900;
  letter-spacing: 0.08em;
  cursor: pointer;
  box-shadow: 0 10px 30px rgba(0,0,0,0.45);
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

.next-button:hover { 
  transform: translateY(-3px); 
  box-shadow: 0 16px 40px rgba(0,0,0,0.55); 
}

#mainContent {
  width: 100%;
  max-width: 800px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
  margin-top: 10px;
  opacity: 0;
  pointer-events: none;
  transform: translateY(8px);
  transition: opacity 0.7s ease, transform 0.7s ease;
}

#mainContent.show {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(0);
}

.links { display: flex; flex-direction: column; align-items: center; gap: 12px; width: 100%; }
.link-button {
  width: min(420px, 92%);
  text-decoration: none;
  color: white;
  background: linear-gradient(135deg, rgba(139,0,0,0.32), rgba(0,0,0,0.36));
  border: 2px solid var(--accent);
  padding: 12px 18px;
  border-radius: 999px;
  font-weight: 800;
  text-align: center;
  box-shadow: 0 8px 26px rgba(0,0,0,0.45);
}

.challenge-badge { 
  margin-top: 8px; 
  padding: 10px 16px; 
  border-radius: 12px; 
  background: linear-gradient(135deg, rgba(139,0,0,0.22), rgba(0,0,0,0.5)); 
  color: #fff; 
  font-weight: 800; 
  border: 1px solid rgba(255,0,0,0.18); 
}

.playlist-btn { 
  display: inline-flex; 
  align-items: center; 
  gap: 8px; 
  padding: 10px 14px; 
  border-radius: 12px; 
  text-decoration: none; 
  color: white; 
  font-weight: 900; 
  background: linear-gradient(90deg, #FF0000, #ff4b4b); 
  border: 2px solid rgba(255,255,255,0.06); 
  box-shadow: 0 10px 30px rgba(0,0,0,0.45); 
}

.overlay { 
  position: fixed; 
  inset: 0; 
  z-index: 9999; 
  display: none; 
  align-items: center; 
  justify-content: center; 
  background: rgba(0,0,0,0.78); 
  backdrop-filter: blur(6px); 
}

.overlay.show { display: flex; }

.codex-card { 
  width: min(1180px, 96%); 
  max-width: 1180px; 
  background: linear-gradient(135deg, rgba(20,20,20,0.96), rgba(10,10,10,0.94)); 
  border-radius: 14px; 
  padding: 28px; 
  box-shadow: 0 30px 80px rgba(0,0,0,0.6); 
  position: relative; 
  overflow: hidden; 
}

.codex-heading { 
  font-size: clamp(1.6rem, 3.6vw, 3rem); 
  font-weight: 900; 
  color: #fff; 
  margin-bottom: 12px; 
  text-align: center; 
}

.codex-logo { 
  display: block; 
  margin: 0 auto 12px; 
  max-width: 760px; 
  width: 86%; 
  height: auto; 
  filter: drop-shadow(0 12px 40px rgba(0,0,0,0.6)); 
}

.logo-rain { 
  position: absolute; 
  inset: 0; 
  pointer-events: none; 
  z-index: 2; 
}

.codex-close { 
  position: absolute; 
  top: 16px; 
  right: 16px; 
  z-index: 10; 
  background: #111; 
  color: #fff; 
  border: 1px solid rgba(255,255,255,0.06); 
  padding: 10px 12px; 
  border-radius: 8px; 
  cursor: pointer; 
  font-weight: 800; 
}

.finale-overlay { 
  position: fixed; 
  inset: 0; 
  z-index: 12000; 
  display: none; 
  align-items: center; 
  justify-content: center; 
  background: rgba(0,0,0,0.88); 
  backdrop-filter: blur(6px); 
}

.finale-overlay.show { display: flex; }

.finale-logo { 
  font-weight: 900; 
  color: #FFD700; 
  text-shadow: 0 0 32px rgba(255,215,0,0.9), 0 0 80px rgba(255,215,0,0.25); 
  font-size: clamp(3.2rem, 10vw, 7.2rem); 
  margin-bottom: 12px; 
  text-align: center; 
}

.finale-banner { 
  padding: 12px 20px; 
  border-radius: 12px; 
  background: linear-gradient(90deg, rgba(255,215,0,0.04), rgba(255,240,180,0.02)); 
  color: #fff; 
  font-weight: 900; 
  text-align: center; 
}

.the-end-overlay { 
  position: fixed; 
  inset: 0; 
  z-index: 13000; 
  display: none; 
  align-items: center; 
  justify-content: center; 
  background: rgba(0,0,0,0.98); 
  color: white; 
  padding: 24px; 
  text-align: center; 
}

.the-end-overlay.show { display: flex; }

.confetti-piece { 
  position: fixed; 
  z-index: 13100; 
  width: 10px; 
  height: 14px; 
  border-radius: 2px; 
  will-change: transform, opacity; 
}

.corner-hotspot { 
  position: fixed; 
  right: 6px; 
  bottom: 6px; 
  width: 56px; 
  height: 56px; 
  z-index: 999; 
  opacity: 0; 
}

@media (max-width: 880px) {
  :root {
    --ui-padding: 12px;
  }
  .card { 
    padding: 24px;
    width: min(90vw, 100%);
  }
  .next-button { 
    padding: 16px 36px; 
    font-size: 1.1rem; 
  }
  .logo { 
    font-size: clamp(2rem, 12vw, 3.2rem); 
  }
  .container {
    gap: 20px;
    padding: 20px;
  }
  #mainContent {
    max-width: 90vw;
  }
}

@media (max-width: 600px) {
  :root {
    --ui-padding: 10px;
  }
  .subtitle {
    text-align: center;
  }
  .card {
    padding: 22px;
    width: min(92vw, 100%);
  }
  .logo {
    font-size: clamp(1.8rem, 9vw, 2.8rem);
  }
  .subtitle {
    font-size: clamp(0.85rem, 2vw, 1rem);
  }
  .day-display {
    font-size: clamp(2.4rem, 10vw, 4rem);
  }
  .day-label {
    font-size: 1.1rem;
  }
  .container {
    gap: 16px;
    padding: 14px;
  }
  .next-button {
    padding: 14px 32px;
    font-size: 1rem;
  }
  #mainContent {
    max-width: 92vw;
  }
  .link-button {
    width: min(90vw, 100%);
    padding: 14px 16px;
    font-size: 0.95rem;
  }
  .challenge-badge {
    padding: 12px 16px;
    font-size: 0.9rem;
  }
}

/* Center the app vertically on larger screens, but keep top-aligned behavior on small devices
   to avoid clipping when mobile browser chrome or the on-screen keyboard changes viewport height. */
@media (min-width: 880px) {
  body {
    align-items: center;
    /* restore a little vertical breathing room on desktop */
    padding: 28px 0;
  }
  .app {
    /* ensure the app fills most of viewport height while still allowing natural flow */
    min-height: calc(100vh - 56px);
  }
}

@media (prefers-reduced-motion: reduce) {
  .particle, .logo-rain, .overlay, .finale-overlay, .day-display { 
    animation: none!important; 
    transition: none!important; 
  }
}
</style>
</head>
<body>
  <!-- background layers -->
  <div class="background" aria-hidden="true"></div>
  <div class="bg-overlay" aria-hidden="true"></div>
  <div class="particles" id="particles" aria-hidden="true"></div>

  <!-- Background audio: place your MP3 at ../Assets/song.mp3 or update the src -->
  <audio id="bgAudio" src="../Assets/song.mp3" loop preload="auto"></audio>
  <div id="audioControls" aria-hidden="false">
    <button id="audioToggle" aria-pressed="false" aria-label="Play background music">üîà</button>
    <input id="audioVolume" type="range" min="0" max="1" step="0.01" value="0.8" aria-label="Background music volume" />
  </div>
<!-- Debug/status area for audio running in the background -->
<div id="audioDebug" aria-live="polite" role="status">
  Audio: initializing...
</div>
<!-- Quick audio snippet inserted per request: uses the existing #bgAudio element -->
<script>
// Put your audio URL here (replace with a real file path or URL)
const audioURL = "your-audio-url-goes-here.mp3";
const _dbgAudio = document.getElementById('audioDebug');
const _audioEl = document.getElementById('bgAudio');
if(_audioEl){
  try{ _audioEl.src = audioURL; }catch(e){}
  _audioEl.addEventListener('canplaythrough', ()=>{
    _audioEl.play().then(()=>{ _dbgAudio.textContent = 'Playing in background.'; }).catch(()=>{ _dbgAudio.textContent = 'Waiting for user interaction...'; });
  });
  document.addEventListener('click', ()=>{
    _audioEl.play().then(()=>{ _dbgAudio.textContent = 'Playing in background.'; }).catch(err=>{ _dbgAudio.textContent = 'Error: ' + (err && err.message ? err.message : String(err)); });
  });
}
</script>


  <!-- Main app -->
  <div class="app" role="application" aria-label="BiniFn challenge app">
    <div class="container">

      <!-- header -->
      <div class="header" role="banner">
        <div class="logo" id="logoTitle" tabindex="0" title="BiniFn">BiniFn</div>
        <div class="subtitle">Gamer ‚Ä¢ Creator ‚Ä¢ Programmer</div>
      </div>

      <!-- main card -->
      <div class="card" role="region" aria-label="Challenge progress">
        <div class="day-label">Challenge Progress</div>
        <div class="day-display" id="dayDisplay">Day 1</div>

        <div class="progress-container" role="group" aria-label="progress">
          <div class="progress-label"><span id="progressText">0%</span><span id="progressTotal">365 Days</span></div>
          <div class="progress-bar" aria-hidden="true"><div class="progress-fill" id="progressFill" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div></div>
        </div>

        <div class="controls" aria-hidden="false">
          <button class="next-button" id="nextBtn" aria-expanded="false">Enter</button>
        </div>
      </div>

      <!-- hidden main content, revealed after pressing Enter -->
      <div id="mainContent" aria-hidden="true">
        <div class="links">
          <a id="linkWebsite" class="link-button" href="https://guns.lol/binifn" target="_blank" rel="noopener noreferrer">üåê Visit Website</a>
          <a id="linkYoutube" class="link-button" href="https://youtube.com/@binifn.x" target="_blank" rel="noopener noreferrer">üì∫ YouTube Channel</a>
        </div>

        <div class="challenge-badge" aria-hidden="false">üéÆ 365 Day Livestream Challenge
          <div style="font-size:.85rem; opacity:.95; margin-top:6px; font-weight:700">November 6th, 2025</div>
        </div>

        <a id="playlistButton" class="playlist-btn" href="https://youtube.com/playlist?list=PLuHsYM1bT176r4owlQ0SIAcGy_NweH8Xm" target="_blank" rel="noopener noreferrer" style="margin-top:12px;">
          <svg width="18" height="12" viewBox="0 0 18 12" aria-hidden="true" style="display:block"><rect width="18" height="12" rx="2" fill="#fff"></rect><polygon points="7,3 12,6 7,9" fill="#FF0000"></polygon></svg>
          <span>üé• Watch the Journey</span>
        </a>
      </div>

    </div>
  </div>

  <!-- Codex overlay: hidden overlay that shows logo and canvas for lego rain -->
  <div class="overlay" id="codexOverlay" role="dialog" aria-hidden="true" aria-modal="true">
    <div class="codex-card" role="document" aria-label="Codex reveal">
      <button class="codex-close" id="codexCloseBtn" title="Close">Close</button>
      <div style="text-align:center;">
        <div id="codexHeading" class="codex-heading">üíΩ Codex Collections ‚Äî Season 2</div>
        <!-- image source now loaded from Assets folder -->
        <img id="codexLogo" class="codex-logo" alt="Codex Logo"
             src="../Assets/codex-logo.jpg" />
      </div>
      <!-- canvas that will render the LEGO stacking rain -->
      <canvas id="logoRain" class="logo-rain" aria-hidden="true"></canvas>
    </div>
  </div>

  <!-- Finale overlay (shown when day >= 365) -->
  <div class="finale-overlay" id="finaleOverlay" role="dialog" aria-hidden="true" aria-modal="true">
    <div style="max-width:1100px; width:92%; padding:18px; text-align:center;">
      <div id="finaleLogo" class="finale-logo">BiniFn</div>
      <div id="finaleBanner" class="finale-banner">üéâ 365 Days Complete ‚Äî BiniFn Challenge Master Unlocked!
        <div style="margin-top:12px">
          <a id="finalePlaylistBtn" class="playlist-btn" href="https://youtube.com/playlist?list=PLuHsYM1bT176r4owlQ0SIAcGy_NweH8Xm" target="_blank" rel="noopener noreferrer" style="padding:10px 14px;">
            <svg width="14" height="10" viewBox="0 0 14 10" aria-hidden="true" style="display:block"><rect width="14" height="10" rx="2" fill="#fff"></rect><polygon points="5,2 10,5 5,8" fill="#FF0000"></polygon></svg>
            <span>Watch Playlist</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- THE END overlay (Day >= 400) -->
  <div class="the-end-overlay" id="theEndOverlay" role="dialog" aria-hidden="true" aria-modal="true">
    <div style="max-width:940px; padding:24px; text-align:center;">
      <h1 style="font-size:clamp(2.4rem,8vw,6rem); margin-bottom:12px;">THE END</h1>
      <p style="font-size:1.25rem;">Thank you for the journey üí´</p>
    </div>
  </div>

  <!-- invisible corner hotspot (triple click triggers the Codex) -->
  <div class="corner-hotspot" id="cornerHotspot" title=""></div>

<script>
/* =========================================================================
   Big JS section
   - Many comments for clarity
   - Holidays, particle engine, Codex lego rain, confetti, finale logic
   ========================================================================= */

/* ---------- Basic preferences ---------- */
const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
const isMobile = ('ontouchstart' in window) || navigator.maxTouchPoints > 0 || window.innerWidth < 768;

/* ---------- Flags (ensure one-time behavior) ---------- */
let codexEffectsTriggered = false; // lego/confetti after codex close ‚Äî only once
let finaleTriggered = false;       // finale (Day >= 365) ‚Äî only once
let theEndShown = false;           // THE END (Day >= 400) ‚Äî only once

/* ---------- Utility functions ---------- */

/**
 * Simple helper: convert hex color to rgba string with alpha
 */
function hexToRgba(hex, alpha = 1) {
  if(!hex) return `rgba(0,0,0,${alpha})`;
  hex = hex.replace('#', '');
  if(hex.length === 3) hex = hex.split('').map(c => c + c).join('');
  const r = parseInt(hex.substr(0,2), 16);
  const g = parseInt(hex.substr(2,2), 16);
  const b = parseInt(hex.substr(4,2), 16);
  return `rgba(${r},${g},${b},${alpha})`;
}

/* ---------- Easter date calculation (Anon Gregorian algorithm) ---------- */
function easterDate(year) {
  const a = year % 19;
  const b = Math.floor(year / 100);
  const c = year % 100;
  const d = Math.floor(b / 4);
  const e = b % 4;
  const f = Math.floor((b + 8) / 25);
  const g = Math.floor((b - f + 1) / 3);
  const h = (19*a + b - d - g + 15) % 30;
  const i = Math.floor(c / 4);
  const k = c % 4;
  const L = (32 + 2*e + 2*i - h - k) % 7;
  const m = Math.floor((a + 11*h + 22*L) / 451);
  const month = Math.floor((h + L - 7*m + 114) / 31);
  const day = ((h + L - 7*m + 114) % 31) + 1;
  return { month, day };
}
function monthName(m) {
  return ['','January','February','March','April','May','June','July','August','September','October','November','December'][m] || '';
}

/* ---------- Build an extensive holidays map for a year ---------- */
function buildSpecialDaysForYear(year) {
  // Map keyed by 'M-D' (e.g. '12-25')
  const map = new Map();

  // Static holidays (a long list to be thorough)
  const add = (m,d,emoji,text,primary,secondary,glow) => {
    map.set(`${m}-${d}`, { emoji, text, primary, secondary, glow });
  };

  // Common holidays (examples)
  add(1,1,'üéâ','New Year\'s Day','#FFD700','#FFA500','#FFD700');
  add(1,6,'üéÑ','Epiphany (Orthodox)','#228B22','#DC143C','#228B22');
  add(1,11,'üá¶üá±','Albanian Republic Day','#FF0000','#000000','#FF0000');
  add(2,14,'üíò','Valentine\'s Day','#FF1493','#FF69B4','#FF1493');
  add(3,8,'üë©','International Women\'s Day','#FF69B4','#FFB6C1','#FF69B4');
  add(3,17,'‚òòÔ∏è','St. Patrick\'s Day','#00FF00','#228B22','#00FF00');
  add(4,1,'ü§°','April Fools\' Day','#9370DB','#BA55D3','#9370DB');
  add(4,22,'üåç','Earth Day','#2E8B57','#98FB98','#2E8B57');
  add(5,1,'‚öíÔ∏è','International Labour Day','#DC143C','#FFD700','#DC143C');
  add(5,9,'üéñÔ∏è','Victory Day (example)','#FFD700','#FF8C00','#FFD700');
  add(6,6,'üïå','Eid al-Adha (approx)','#228B22','#FFD700','#228B22');
  add(7,4,'üá∫üá∏','Independence Day (USA)','#0000FF','#FF0000','#0000FF');
  add(10,31,'üéÉ','Halloween','#FF8C00','#8B008B','#FF8C00');
  add(11,7,'üéÆ','Challenge Launch Day','#FF4500','#FF8C00','#FF4500');
  add(11,28,'üá¶üá±','Albanian Independence Day','#FF0000','#000000','#FF0000');
  add(12,24,'üéÑ','Christmas Eve','#228B22','#DC143C','#228B22');
  add(12,25,'üéÖ','Christmas Day','#DC143C','#228B22','#DC143C');
  add(12,31,'üéä','New Year\'s Eve','#FFD700','#FF1493','#FFD700');

  // Add computed Easter (Sunday + Monday)
  const e = easterDate(year);
  add(e.month, e.day, 'üê£', `Easter Sunday (${monthName(e.month)} ${e.day})`, '#FFD700','#FF69B4','#FFD700');
  const em = new Date(year, e.month-1, e.day+1);
  add(em.getMonth()+1, em.getDate(), 'üå∑', `Easter Monday (${monthName(em.getMonth()+1)} ${em.getDate()})`, '#FFECB3','#FFCCBC','#FFB6C1');

  // Return the map
  return map;
}

/* ---------- Apply a theme for today (if holiday exists) ---------- */
function applyThemeForToday() {
  const today = new Date();
  const key = `${today.getMonth()+1}-${today.getDate()}`;
  const map = buildSpecialDaysForYear(today.getFullYear());
  const info = map.get(key) || null;
  if(!info) return; // no theme for today

  // set CSS custom properties for accent colors
  document.documentElement.style.setProperty('--accent', info.primary);
  document.documentElement.style.setProperty('--accent-dark', info.secondary);
  document.documentElement.style.setProperty('--glow', info.glow || info.primary);
  document.documentElement.style.setProperty('--bg-tint', hexToRgba(info.primary, 0.22));

  // Update some UI elements directly for immediate effect
  const logo = document.getElementById('logoTitle'); if(logo) logo.style.textShadow = `0 0 10px ${info.glow}, 0 0 20px ${info.glow}, 0 0 30px ${info.secondary}`;
  const pf = document.getElementById('progressFill'); if(pf) pf.style.background = `linear-gradient(90deg, ${info.secondary}, ${info.primary})`;
  const card = document.querySelector('.card'); if(card) card.style.borderColor = info.primary;
  recolorParticles(info.primary, info.glow);
  // add a badge in code if you want (optional)
  // (omitted on-screen badge to stay minimal here)
}

/* ---------- Particle generation (background little dots) ---------- */
function createParticles(){
  const container = document.getElementById('particles');
  if(!container) return;
  container.innerHTML = '';
  const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
  const baseCount = isMobile ? 12 : 28;
  const count = prefersReduced ? Math.round(baseCount * 0.35) : baseCount;
  for(let i=0;i<count;i++){
    const el = document.createElement('div'); el.className = 'particle';
    el.style.left = Math.random()*100 + '%';
    el.style.top = (75 + Math.random()*25) + '%';
    el.style.animationDelay = (Math.random()*12) + 's';
    el.style.animationDuration = (10 + Math.random()*10) + 's';
    el.style.transform = `translateX(${(Math.random()-0.5)*80}px)`;
    const accent = getComputedStyle(document.documentElement).getPropertyValue('--accent') || '#ff0000';
    el.style.background = accent;
    el.style.boxShadow = `0 0 8px ${accent}`;
    container.appendChild(el);
  }
}
function recolorParticles(color, glow) {
  document.querySelectorAll('.particle').forEach(el => {
    el.style.background = color;
    el.style.boxShadow = `0 0 8px ${glow || color}`;
  });
}

/* ---------- Challenge day calculation ---------- */
function calculateChallengeDay(){
  // Start date anchored to Nov 8, 2025 (local midnight)
  const startDate = new Date('2025-11-08T00:00:00');
  const today = new Date();
  startDate.setHours(0,0,0,0); today.setHours(0,0,0,0);
  const diff = Math.floor((today - startDate) / (1000*60*60*24));
  return diff >= 0 ? diff : 0;
}
function updateDayDisplay(){
  const day = calculateChallengeDay();
  const percent = ((day/365) * 100);
  const dayEl = document.getElementById('dayDisplay');
  const progText = document.getElementById('progressText');
  const pf = document.getElementById('progressFill');
  if(dayEl) dayEl.textContent = `Day ${day}`;
  if(progText) progText.textContent = `${percent.toFixed(1)}%`;
  if(pf) {
    setTimeout(()=> { pf.style.width = Math.min(percent,100) + '%'; pf.setAttribute('aria-valuenow', Math.round(percent)); }, 90);
  }

  // trigger finale if we've reached day >= 365
  if(day >= 365) triggerFinaleOnce();

  // show THE END on day >= 400
  if(day >= 400 && !theEndShown) showTheEnd();
}

/* ---------- Enter button behaviour (reveals main content) ---------- */
const nextBtn = document.getElementById('nextBtn');
const mainContent = document.getElementById('mainContent');
if(nextBtn) nextBtn.addEventListener('click', ()=> {
  // hide button with a quick fade then reveal content
  nextBtn.setAttribute('aria-expanded','true');
  nextBtn.style.transition = 'opacity 320ms ease, transform 320ms ease';
  nextBtn.style.opacity = '0';
  nextBtn.style.transform = 'translateY(6px) scale(.98)';
  setTimeout(()=> {
    nextBtn.style.display = 'none';
    if(mainContent){
      mainContent.classList.add('show');
      mainContent.setAttribute('aria-hidden','false');
    }
  }, 340);
});

/* ---------- Codex overlay (open/close + lego rain) ---------- */
const codexOverlay = document.getElementById('codexOverlay');
const codexCloseBtn = document.getElementById('codexCloseBtn');
const codexLogoEl = document.getElementById('codexLogo');
const logoCanvas = document.getElementById('logoRain');
const codexCtx = logoCanvas && logoCanvas.getContext ? logoCanvas.getContext('2d') : null;

/* Resize canvas to overlay size */
function resizeCodex(){
  if(!codexCtx) return;
  const rect = codexOverlay.getBoundingClientRect();
  logoCanvas.width = Math.max(300, Math.floor(rect.width));
  logoCanvas.height = Math.max(200, Math.floor(rect.height));
}

/* Open Codex: show overlay and start rain using the logo */
function openCodex(){
  if(!codexOverlay) return;
  codexOverlay.classList.add('show');
  codexOverlay.setAttribute('aria-hidden','false');
  resizeCodex();

  // Attempt to load the provided image for use as rainy tiles.
  const imgSrc = codexLogoEl && codexLogoEl.getAttribute('src') ? codexLogoEl.getAttribute('src') : '';
  if(imgSrc){
    const img = new Image();
    img.crossOrigin = 'anonymous';
    img.onload = ()=> startLogoRain(img);
    img.onerror = ()=> startLogoRain(null);
    img.src = imgSrc;
  } else {
    startLogoRain(null);
  }
}

/* Close Codex: stop the rain, hide overlay. Then run the one-time main celebration (if not triggered). */
function closeCodex(){
  if(!codexOverlay) return;
  codexOverlay.classList.remove('show');
  codexOverlay.setAttribute('aria-hidden','true');
  stopLogoRain();
}

/* Hook the close button to close codex and run single-time effects */
if(codexCloseBtn){
  codexCloseBtn.addEventListener('click', ()=> {
    closeCodex();
    if(!codexEffectsTriggered){
      codexEffectsTriggered = true;
      // After closing, run a short lego burst + confetti on main page
      startLogoRainOnceShort();
    }
  });
}

/* ---------- LEGO stacking engine (canvas) ---------- */

/*
  Approach:
  - Maintain a falling list and a placed list.
  - Each falling brick has x,y,w,h,vy,rotation,color,maybe logo.
  - When a falling brick reaches the top of the stack in its columns, we place it and update column heights.
  - When columns are tall enough to fill the canvas, we consider it "filled".
*/
let codexRain = {
  running: false,
  columns: [],
  unit: 18,
  placed: [],
  falling: [],
  spawnId: null,
  anim: null,
  spawnRate: 36
};

/* Basic rounded rect utility for canvas drawing */
function roundRect(ctx, x, y, w, h, r){
  if(w < 2*r) r = w/2;
  if(h < 2*r) r = h/2;
  ctx.beginPath();
  ctx.moveTo(x + r, y);
  ctx.arcTo(x + w, y, x + w, y + h, r);
  ctx.arcTo(x + w, y + h, x, y + h, r);
  ctx.arcTo(x, y + h, x, y, r);
  ctx.arcTo(x, y, x + w, y, r);
  ctx.closePath();
}

/* Draw a placed brick with studs */
function drawPlaced(b){
  if(!codexCtx) return;
  codexCtx.save();
  codexCtx.translate(b.x + b.w/2, b.y + b.h/2);
  codexCtx.fillStyle = b.color || '#e41e26';
  roundRect(codexCtx, -b.w/2, -b.h/2, b.w, b.h, Math.max(2, b.h * 0.18));
  codexCtx.fill();

  // studs
  const studCount = Math.max(1, Math.floor(b.w / 18));
  const studRadius = Math.max(3, Math.min(6, b.h * 0.16));
  codexCtx.fillStyle = 'rgba(255,255,255,0.06)';
  for(let s=0; s<studCount; s++){
    const sx = -b.w/2 + (s + 0.5) * (b.w / studCount);
    const sy = -b.h/2 + studRadius + 1;
    codexCtx.beginPath(); codexCtx.arc(sx, sy, studRadius, 0, Math.PI*2); codexCtx.fill();
  }

  codexCtx.restore();
}

/* Draw a falling brick (can be simple rectangle or logo tile) */
function drawFalling(f){
  if(!codexCtx) return;
  codexCtx.save();
  codexCtx.translate(f.x + f.w/2, f.y + f.h/2);
  codexCtx.rotate(f.rotation || 0);
  if(f.logo){
    try {
      const tileW = Math.min(f.w, 48);
      const tileH = Math.min(f.h, 48);
      codexCtx.drawImage(f.logo, -tileW/2, -tileH/2, tileW, tileH);
    } catch(e) {
      codexCtx.fillStyle = f.color || '#3498db';
      roundRect(codexCtx, -f.w/2, -f.h/2, f.w, f.h, Math.max(2, f.h*0.18));
      codexCtx.fill();
    }
  } else {
    codexCtx.fillStyle = f.color || '#3498db';
    roundRect(codexCtx, -f.w/2, -f.h/2, f.w, f.h, Math.max(2, f.h*0.18));
    codexCtx.fill();
  }

  // studs
  const studCount = Math.max(1, Math.floor(f.w / 18));
  const studRadius = Math.max(3, Math.min(6, f.h * 0.16));
  codexCtx.fillStyle = 'rgba(255,255,255,0.06)';
  for(let s=0; s<studCount; s++){
    const sx = -f.w/2 + (s + 0.5) * (f.w / studCount);
    const sy = -f.h/2 + studRadius + 1;
    codexCtx.beginPath(); codexCtx.arc(sx, sy, studRadius, 0, Math.PI*2); codexCtx.fill();
  }

  codexCtx.restore();
}

/* Start the rain: spawn bricks periodically and animate */
function startLogoRain(logoImage){
  if(!codexCtx) return;
  stopLogoRain();

  resizeCodex();
  codexRain.running = true;
  codexRain.placed = [];
  codexRain.falling = [];
  codexRain.unit = Math.max(12, Math.floor(logoCanvas.width / 60));
  const columnsCount = Math.max(12, Math.floor(logoCanvas.width / codexRain.unit));
  codexRain.columns = new Array(columnsCount).fill(0);

  const colors = ['#e41e26','#f1c40f','#3498db','#2ecc71','#8e44ad','#f39c12','#16a085'];

  codexRain.spawnId = setInterval(() => {
    if(!codexRain.running) return;
    const wUnits = 1 + Math.floor(Math.random()*3);
    const w = Math.min(wUnits, codexRain.columns.length) * codexRain.unit - 2;
    const h = Math.max(8, Math.floor(codexRain.unit * (0.28 + Math.random()*0.5)));
    const x = Math.random() * (logoCanvas.width - w);
    const color = colors[Math.floor(Math.random()*colors.length)];
    const brick = { x, y: -h - (Math.random()*80), w, h, color, vy: 2 + Math.random()*3, rotation:(Math.random()-0.5)*0.06 };

    // Occasionally use the codex logo as a tile
    if(logoImage && Math.random() < 0.08) brick.logo = logoImage;

    codexRain.falling.push(brick);
  }, Math.max(20, codexRain.spawnRate));

  function animate(){
    if(!codexRain.running) return;
    codexCtx.clearRect(0,0,logoCanvas.width,logoCanvas.height);

    // draw placed bricks
    for(const b of codexRain.placed) drawPlaced(b);

    // update falling bricks
    for(let i = codexRain.falling.length - 1; i >= 0; i--){
      const f = codexRain.falling[i];
      f.vy += 0.08;
      f.y += f.vy;
      f.x += Math.sin(f.y * 0.012) * 0.3;
      f.rotation += (f.rotation * 0.02);

      const leftCol = Math.max(0, Math.floor(f.x / codexRain.unit));
      const rightCol = Math.min(codexRain.columns.length - 1, Math.floor((f.x + f.w) / codexRain.unit));

      let maxh = 0;
      for(let c = leftCol; c <= rightCol; c++) maxh = Math.max(maxh, codexRain.columns[c]);
      const surfaceY = logoCanvas.height - maxh;

      if(f.y + f.h >= surfaceY){
        // place it
        const placedY = surfaceY - f.h;
        const placed = { x: Math.max(0, Math.min(logoCanvas.width - f.w, Math.round(f.x))), y: Math.round(placedY), w: f.w, h: f.h, color: f.color };
        codexRain.placed.push(placed);
        for(let c = leftCol; c <= rightCol; c++) codexRain.columns[c] += f.h;
        codexRain.falling.splice(i, 1);
      } else {
        drawFalling(f);
      }
    }

    // draw falling bricks after updates
    // (we already drew them above while updating)

    // check if canvas is essentially filled
    const allFilled = codexRain.columns.every(h => h >= logoCanvas.height - 6);
    if(allFilled){
      // once the canvas fills, trigger confetti and auto-stop
      confettiExplosion(false);
      activateCinematicPulse(true);
      stopLogoRain();
      for(const b of codexRain.placed) drawPlaced(b);
      return;
    }

    codexRain.anim = requestAnimationFrame(animate);
  }
  codexRain.anim = requestAnimationFrame(animate);

  // safety auto-stop after 35s to avoid runaway
  setTimeout(()=> {
    if(codexRain.running){
      confettiExplosion(false);
      activateCinematicPulse(true);
      stopLogoRain();
    }
  }, 35000);
}

/* Stop the rain engine and clear */
function stopLogoRain(){
  codexRain.running = false;
  if(codexRain.spawnId){ clearInterval(codexRain.spawnId); codexRain.spawnId = null; }
  if(codexRain.anim){ cancelAnimationFrame(codexRain.anim); codexRain.anim = null; }
  if(codexCtx) codexCtx.clearRect(0,0,logoCanvas.width,logoCanvas.height);
}

/* Short lego burst on the main page (DOM bricks) used once after codex closes */
function startLogoRainOnceShort(){
  if(prefersReducedMotion) return;
  const count = isMobile ? 12 : 28;
  for(let i=0;i<count;i++){
    const el = document.createElement('div');
    el.style.position = 'fixed';
    el.style.left = Math.random()*86 + 6 + 'vw';
    el.style.top = '-40px';
    el.style.zIndex = 11000;
    const w = 12 + Math.random()*28;
    el.style.width = w + 'px';
    el.style.height = (w * 0.6) + 'px';
    el.style.background = ['#e41e26','#f1c40f','#3498db','#2ecc71','#8e44ad','#f39c12'][Math.floor(Math.random()*6)];
    el.style.borderRadius = '4px';
    el.style.boxShadow = '0 6px 18px rgba(0,0,0,0.4)';
    el.style.transform = `rotate(${Math.random()*40-20}deg)`;
    document.body.appendChild(el);
    const duration = 1600 + Math.random()*1400;
    el.animate([{ transform: el.style.transform, opacity:1 }, { transform: `translateY(${window.innerHeight + 160}px) rotate(${Math.random()*720-360}deg)`, opacity:0 }], { duration, easing:'cubic-bezier(.2,.8,.2,1)' });
    setTimeout(()=> el.remove(), duration + 80);
  }
  // small confetti after the bricks
  setTimeout(()=> confettiExplosion(false), 900);
}

/* Cinematic pulse (quick screen flash) */
function activateCinematicPulse(louder=false){
  const pulse = document.createElement('div');
  pulse.style.position = 'fixed';
  pulse.style.inset = 0;
  pulse.style.zIndex = 10002;
  pulse.style.pointerEvents = 'none';
  pulse.style.background = louder ? 'radial-gradient(circle at 50% 40%, rgba(255,255,255,0.06), rgba(0,0,0,0))' : 'radial-gradient(circle at 50% 40%, rgba(255,255,255,0.03), rgba(0,0,0,0))';
  document.body.appendChild(pulse);
  setTimeout(()=> { pulse.style.transition = 'opacity .9s'; pulse.style.opacity = '0'; setTimeout(()=> pulse.remove(), 950); }, 120);
}

/* ---------- Confetti explosion (DOM-based) ---------- */
function confettiExplosion(finale=false){
  if(prefersReducedMotion) return;
  const count = (finale ? 300 : 120) + (isMobile ? -40 : 0);
  const colors = finale ? ['#FFD700','#FFD166','#FFB700','#FFDA6A'] : ['#e41e26','#f1c40f','#3498db','#2ecc71','#8e44ad','#f39c12'];
  const pieces = [];
  for(let i=0;i<count;i++){
    const el = document.createElement('div'); el.className = 'confetti-piece';
    const w = 6 + Math.round(Math.random()*12), h = 8 + Math.round(Math.random()*10);
    el.style.width = w + 'px';
    el.style.height = h + 'px';
    el.style.left = (50 + (Math.random()-0.5)*80) + 'vw';
    el.style.top = (20 + Math.random()*20) + 'vh';
    const color = colors[Math.floor(Math.random()*colors.length)];
    el.style.background = color;
    el.style.transform = `translate3d(0,0,0) rotate(${Math.random()*360}deg)`;
    document.body.appendChild(el);
    const vx = (Math.random()-0.5) * (finale ? 24 : 20);
    const vy = -6 - Math.random() * (finale ? 12 : 8);
    const vr = (Math.random()-0.5) * 0.8;
    pieces.push({ el, x: el.offsetLeft, y: el.offsetTop, vx, vy, vr, life: 0 });
  }
  const gravity = finale ? 0.7 : 0.55;
  function tick(){
    for(let i=pieces.length-1;i>=0;i--){
      const p = pieces[i];
      p.vy += gravity * (finale ? 0.45 : 0.4);
      p.x += p.vx; p.y += p.vy;
      p.vx *= 0.995; p.vy *= 0.998;
      p.vr += (Math.random() - 0.5) * 0.02;
      p.life += 1;
      p.el.style.transform = `translate3d(${p.x}px,${p.y}px,0) rotate(${p.vr * p.life}rad)`;
      p.el.style.opacity = Math.max(0, 1 - p.life / (finale ? 200 : 160));
      if(p.life > (finale ? 260 : 220) || p.y > window.innerHeight + 120){
        p.el.remove(); pieces.splice(i,1);
      }
    }
    if(pieces.length) requestAnimationFrame(tick);
  }
  tick();
}

/* ---------- Secret corner & keyboard codes ---------- */
const corner = document.getElementById('cornerHotspot');
let cornerClicks = 0;
if(corner){
  corner.addEventListener('click', () => {
    cornerClicks++;
    if(cornerClicks >= 3){
      openCodex();
      cornerClicks = 0;
    }
    setTimeout(()=> { cornerClicks = 0; }, 1500);
  });
}

// keyboard CODEX -> open codex
const keyBuffer = [];
document.addEventListener('keydown', (e) => {
  keyBuffer.push(e.key.toUpperCase());
  if(keyBuffer.length > 60) keyBuffer.shift();
  const combo = keyBuffer.join('');
  if(combo.includes('CODEX')) openCodex();
});

/* ---------- Logo click fun (kept hidden behaviors) ---------- */
let logoClicks = 0, logoClickTimer = null;
const logoEl = document.getElementById('logoTitle');
if(logoEl){
  logoEl.addEventListener('click', () => {
    logoClicks++;
    if(logoClicks === 10){
      flashMessage('üî• Elite Club Unlocked ‚Äî 10 clicks!');
      eliteGlow();
      logoClicks = 0;
    }
    clearTimeout(logoClickTimer);
    logoClickTimer = setTimeout(()=> { logoClicks = 0; }, 1200);
  });
}

/* long-press (Noor Mode) preserved but no UI hint */
let logoPressTimer = null;
logoEl.addEventListener('touchstart', e => { logoPressTimer = setTimeout(()=>{ setNoorTheme(); flashMessage('üïØÔ∏è Noor Mode'); }, 700); }, {passive:true});
logoEl.addEventListener('touchend', e => { clearTimeout(logoPressTimer); }, {passive:true});
logoEl.addEventListener('mousedown', e => { logoPressTimer = setTimeout(()=>{ setNoorTheme(); flashMessage('üïØÔ∏è Noor Mode'); }, 800); });
logoEl.addEventListener('mouseup', e => { clearTimeout(logoPressTimer); });

/* ---------- Small helpers ---------- */
function flashMessage(text, timeout=2200){
  const el = document.createElement('div');
  el.textContent = text;
  el.style.position = 'fixed';
  el.style.left = '50%';
  el.style.transform = 'translateX(-50%)';
  el.style.bottom = '12%';
  el.style.zIndex = 14000;
  el.style.background = 'linear-gradient(90deg, rgba(255,255,255,0.06), rgba(0,0,0,0.15))';
  el.style.padding = '12px 18px';
  el.style.borderRadius = '12px';
  el.style.border = '1px solid rgba(255,255,255,0.06)';
  el.style.boxShadow = '0 12px 40px rgba(0,0,0,0.6)';
  el.style.fontWeight = '800';
  document.body.appendChild(el);
  setTimeout(()=>{ el.style.transition = 'opacity .5s'; el.style.opacity = '0'; setTimeout(()=> el.remove(), 600); }, timeout);
}
function eliteGlow(){
  const logo = document.getElementById('logoTitle');
  if(!logo) return;
  const prev = getComputedStyle(logo).textShadow;
  // Using Web Animations API to animate text-shadow (some browsers will ignore; it's fine)
  logo.animate([{ textShadow: prev }, { textShadow: `0 0 28px #FFD700, 0 0 58px #FF8C00` }], { duration: 1200, fill: 'forwards' });
  activateTinyConfetti();
}
function activateTinyConfetti(){
  if(prefersReducedMotion) return;
  for(let i=0;i<28;i++){
    const c = document.createElement('div');
    c.style.position='fixed'; c.style.left = Math.random()*100 + '%'; c.style.top='20%';
    c.style.width='8px'; c.style.height='8px'; c.style.borderRadius='2px'; c.style.zIndex=11000;
    c.style.background = '#'+Math.floor(Math.random()*16777215).toString(16); c.style.opacity=0.95;
    c.style.transform = 'translateY(0)'; c.style.transition = 'transform 1.4s cubic-bezier(.1,.7,.2,1), opacity 1.4s';
    document.body.appendChild(c);
    requestAnimationFrame(()=> c.style.transform = `translateY(${200+Math.random()*220}px) rotate(${Math.random()*160}deg)`);
    setTimeout(()=> c.style.opacity=0, 1300);
    setTimeout(()=> c.remove(), 1800);
  }
}

/* ---------- Finale (day >= 365) & THE END (day >= 400) ---------- */
const finaleOverlay = document.getElementById('finaleOverlay');
const theEndOverlay = document.getElementById('theEndOverlay');

function triggerFinaleOnce(){
  if(finaleTriggered) return;
  finaleTriggered = true;
  showFinale();
}

function showFinale(){
  if(!finaleOverlay) return;
  finaleOverlay.classList.add('show');
  finaleOverlay.setAttribute('aria-hidden','false');
  const logo = document.getElementById('finaleLogo');
  if(logo){ logo.style.transform = 'scale(.7)'; logo.style.opacity = '0'; setTimeout(()=>{ logo.style.transition = 'transform 900ms cubic-bezier(.2,.9,.2,1), opacity 600ms ease'; logo.style.transform = 'scale(1.04)'; logo.style.opacity = '1'; }, 50); }

  confettiExplosion(true);
  document.documentElement.style.setProperty('--accent', '#FFD700');
  recolorParticles('#FFD700','#FFD700');

  // allow close on click or ESC
  function closeFn(){
    finaleOverlay.classList.remove('show'); finaleOverlay.setAttribute('aria-hidden','true');
    document.removeEventListener('click', closeFn);
    document.removeEventListener('keydown', keyHandler);
  }
  function keyHandler(e){ if(e.key === 'Escape') closeFn(); }
  document.addEventListener('click', closeFn);
  document.addEventListener('keydown', keyHandler);
}

function showTheEnd(){
  if(theEndShown) return;
  theEndShown = true;
  // fade out main UI and show THE END overlay
  const app = document.querySelector('.app');
  if(app){
    app.style.transition = 'opacity 900ms ease';
    app.style.opacity = '0';
    setTimeout(()=> {
      if(app) app.style.display = 'none';
      if(theEndOverlay) { theEndOverlay.classList.add('show'); theEndOverlay.setAttribute('aria-hidden','false'); }
      confettiExplosion(true);
    }, 1000);
  } else {
    if(theEndOverlay) { theEndOverlay.classList.add('show'); theEndOverlay.setAttribute('aria-hidden','false'); }
  }
}

/* ---------- Startup tasks ---------- */
createParticles();
updateDayDisplay();
applyThemeForToday();
resizeCodex();

/* refresh logic at midnight to update day/holiday */
(function scheduleMidnightUpdate(){
  const now = new Date();
  const next = new Date(now.getFullYear(), now.getMonth(), now.getDate() + 1, 0, 0, 8);
  setTimeout(()=> {
    updateDayDisplay();
    applyThemeForToday();
    scheduleMidnightUpdate();
  }, next - now);
})();

/* window resize handling (recreate particles & resize codex canvas) */
let resizeTimer;
window.addEventListener('resize', ()=> {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(()=> {
    createParticles();
    applyThemeForToday();
    resizeCodex();
  }, 240);
}, { passive: true });

/* Expose debugging helpers in console (optional) */
window.openCodex = openCodex;
window.closeCodex = closeCodex;
window.showFinale = showFinale;
window.showTheEnd = showTheEnd;
window.activateMatrix = function(){ console.warn('Matrix debug available via activateMatrix()'); };

/* Prevent accidental repeated spawn: we don't attach global click->confetti anywhere.
   Confetti/lego only trigger via:
   - codex close (once)
   - final events (once)
   - explicit debug calls.
*/

/* End of big JS */
</script>
<!-- Audio playback wiring: starts on user gesture (Enter button) and provides a toggle -->
<script>
(function(){
  const audio = document.getElementById('bgAudio');
  const toggle = document.getElementById('audioToggle');
  const vol = document.getElementById('audioVolume');
  const nextBtn = document.getElementById('nextBtn');
  const debug = document.getElementById('audioDebug');
  const chooseBtn = document.getElementById('audioChooseBtn');
  const filePicker = document.getElementById('audioFilePicker');

  if(!audio || !toggle || !debug) return;

  function setDebug(msg, isError=false){
    debug.textContent = msg;
    // use themed colors: normal messages use --text, errors use --accent
    try{
      debug.style.color = isError ? 'var(--accent)' : 'var(--text)';
    }catch(e){
      // fallback
      debug.style.color = isError ? '#ff9999' : '';
    }
  }

  // candidate paths to try (relative to the page). GitHub Pages often publishes site at /<repo>/ so ../Assets is commonly correct
  const candidates = [
    '../Assets/song.mp3',
    './Assets/song.mp3',
    'Assets/song.mp3',
    '/Assets/song.mp3'
  ];

  // If the audio already has a src, attempt to verify it first.
  async function verifyCurrentOrFind(){
    const cur = audio.getAttribute('src');
    if(cur){
      try{
        const ok = await probeUrl(cur);
        if(ok){ setDebug('Audio found at: ' + cur); return cur; }
      }catch(e){}
    }

    for(const p of candidates){
      try{
        const ok = await probeUrl(p);
        if(ok){ setDebug('Audio found at: ' + p); return p; }
      }catch(e){ /* ignore */ }
    }
    return null;
  }

  // probe using HEAD then fallback to GET if needed
  async function probeUrl(url){
    try{
      const resp = await fetch(url, { method: 'HEAD', cache: 'no-store' });
      return resp && resp.ok;
    }catch(e){
      // some servers may not allow HEAD; try GET without downloading body
      try{
        const resp = await fetch(url, { method: 'GET', cache: 'no-store' });
        return resp && resp.ok;
      }catch(err){
        return false;
      }
    }
  }

  // initialize audio source (async)
  (async function initAudio(){
    setDebug('Checking audio asset‚Ä¶');
    const found = await verifyCurrentOrFind();
    if(found){
      // set resolved src and let rest of wiring handle playback
      if(audio.getAttribute('src') !== found){ audio.setAttribute('src', found); }
      try{ await audio.load(); }catch(e){}
      setDebug('Ready ‚Äî press Enter or the audio button to start');
    } else {
      setDebug('Audio file not found. Click "Choose local audio‚Ä¶" to pick a file for testing.', true);
      // show the local-file fallback button
      chooseBtn.style.display = 'inline-block';
    }
  })();

  // wire choose button -> file picker fallback
  chooseBtn.addEventListener('click', ()=> filePicker.click());
  filePicker.addEventListener('change', (e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    const url = URL.createObjectURL(f);
    audio.src = url;
    audio.load();
    audio.play().then(()=> { toggle.textContent = 'üîä'; toggle.setAttribute('aria-pressed','true'); setDebug('Playing selected file'); }).catch((err)=>{ setDebug('Selected file loaded but playback blocked (click to start)', true); console.warn(err); });
  });

  // restore saved preference (volume & playback state)
  const saved = localStorage.getItem('bgAudioPlaying') === '1';
  const savedVol = parseFloat(localStorage.getItem('bgAudioVolume'));
  if(!isNaN(savedVol) && vol){ vol.value = String(savedVol); audio.volume = savedVol; }
  else if(vol){ audio.volume = parseFloat(vol.value || 0.8); }

  if(saved){
    // attempt to play; may still be blocked until user gesture
    audio.play().then(()=>{ toggle.textContent = 'üîä'; toggle.setAttribute('aria-pressed','true'); setDebug('Playing (restored)'); }).catch(()=>{ setDebug('Playback restored but blocked until user gesture'); });
  }

  // start playback on the Enter button (user gesture)
  if(nextBtn){ nextBtn.addEventListener('click', ()=> { audio.play().catch((e)=>{ setDebug('Playback blocked ‚Äî tap audio button', true); }); }); }

  // attempt play on any first interaction (tap/click) for mobile users
  function tryPlayOnFirstInteraction(){
    function handler(){
      audio.play().catch(()=>{});
      window.removeEventListener('touchstart', handler, {passive:true});
      window.removeEventListener('click', handler);
    }
    window.addEventListener('touchstart', handler, {passive:true});
    window.addEventListener('click', handler);
  }
  tryPlayOnFirstInteraction();

  // volume slider handling (make robust for touch/pointer devices)
  // inline/mobile slider (syncs with top-right slider)
  if(vol){
    const setVolumeFromInput = (val)=>{
      const v = parseFloat(val);
      const newVol = isNaN(v) ? 0.8 : v;
      audio.volume = newVol;
      // remember the user's last non-zero volume for unmute
      if(newVol > 0) localStorage.setItem('bgAudioLastVolume', String(newVol));
      localStorage.setItem('bgAudioVolume', String(audio.volume));
      if(audio.volume === 0){ toggle.textContent = 'üîá'; }
      else if(!audio.paused) { toggle.textContent = 'üîä'; }
      else { toggle.textContent = 'üîà'; }
      setDebug('Ready ‚Äî volume: ' + Math.round(audio.volume * 100) + '%');
    };
    vol.addEventListener('input', (e)=> setVolumeFromInput(e.target.value));
    vol.addEventListener('change', (e)=> setVolumeFromInput(e.target.value));
    // pointer/touch move support for some mobile browsers
    vol.addEventListener('pointermove', (e)=> { if(e.buttons) setVolumeFromInput(e.target.value); });
    vol.addEventListener('touchmove', (e)=> { setVolumeFromInput(e.target.value); }, {passive:true});
  }

  // show/hide volume slider when user interacts with the toggle
  const controls = document.getElementById('audioControls');
  let volumeHideTimer = null;
  function showVolumeTemporary(ms = 3500){ if(!controls) return; controls.classList.add('show-volume'); if(volumeHideTimer) clearTimeout(volumeHideTimer); volumeHideTimer = setTimeout(()=>{ controls.classList.remove('show-volume'); volumeHideTimer = null; }, ms); }

  // toggle button behavior:
  // - If the slider is at 0 (muted), clicking the button will restore last non-zero volume and play (acts as unmute)
  // - Otherwise the button acts as play/pause (does not change volume)
  toggle.addEventListener('click', async ()=>{
    showVolumeTemporary();
    try{
      const lastVol = parseFloat(localStorage.getItem('bgAudioLastVolume')) || 0.8;
      if(audio.volume === 0){
        // unmute to last volume and start playback
        audio.volume = lastVol;
        if(vol) vol.value = String(audio.volume);
        await audio.play();
        toggle.textContent = 'üîä'; toggle.setAttribute('aria-pressed','true'); localStorage.setItem('bgAudioPlaying','1'); setDebug('Unmuted ‚Äî volume: ' + Math.round(audio.volume*100) + '%');
        return;
      }

      // normal play/pause toggle (preserve volume)
      if(audio.paused){
        await audio.play();
        toggle.textContent = 'üîä'; toggle.setAttribute('aria-pressed','true'); localStorage.setItem('bgAudioPlaying','1'); setDebug('Playing');
      } else {
        audio.pause(); toggle.textContent = 'üîà'; toggle.setAttribute('aria-pressed','false'); localStorage.setItem('bgAudioPlaying','0'); setDebug('Paused');
      }
    }catch(e){
      console.warn('Audio playback blocked or failed', e);
      setDebug('Playback blocked by browser ‚Äî tap Enter or the audio button once to allow sound', true);
    }
  });

  // keep slider visible while user is dragging it
  if(vol){ vol.addEventListener('pointerdown', ()=>{ if(volumeHideTimer) clearTimeout(volumeHideTimer); controls.classList.add('show-volume'); }); vol.addEventListener('pointerup', ()=>{ showVolumeTemporary(3000); }); }

  // surface load errors on the audio element
  audio.addEventListener('error', ()=>{
    setDebug('Audio failed to load from configured path. Try the "Choose local audio‚Ä¶" button or fix the asset path.', true);
    chooseBtn.style.display = 'inline-block';
  });

})();
</script>
</body>
</html>
